import requests
import json
from datetime import datetime

# Configurazione API
OPEN_METEO_API = "https://api.open-meteo.com/v1/forecast"
GEOCODING_API = "https://geocoding-api.open-meteo.com/v1/search"

def get_coordinates(city_name):
    """
    Recupera le coordinate (lat, lon) di una cittÃ 
    """
    try:
        params = {
            "name": city_name,
            "count": 1,
            "language": "it",
            "format": "json"
        }
        response = requests.get(GEOCODING_API, params=params)
        response.raise_for_status()
        
        data = response.json()
        
        if not data.get("results"):
            print(f"âŒ CittÃ  '{city_name}' non trovata")
            return None
        
        result = data["results"][0]
        return {
            "latitude": result["latitude"],
            "longitude": result["longitude"],
            "name": result["name"],
            "country": result.get("country", "")
        }
    
    except requests.exceptions.RequestException as e:
        print(f"âŒ Errore nella richiesta di geocoding: {e}")
        return None

def get_weather(latitude, longitude):
    """
    Recupera i dati meteo attuali
    """
    try:
        params = {
            "latitude": latitude,
            "longitude": longitude,
            "current": "temperature_2m,weather_code,wind_speed_10m,relative_humidity_2m",
            "temperature_unit": "celsius",
            "wind_speed_unit": "kmh",
            "timezone": "auto"
        }
        response = requests.get(OPEN_METEO_API, params=params)
        response.raise_for_status()
        
        return response.json()
    
    except requests.exceptions.RequestException as e:
        print(f"âŒ Errore nella richiesta meteo: {e}")
        return None

def interpret_weather_code(code):
    """
    Interpreta il codice meteo WMO
    """
    weather_codes = {
        0: "â˜€ï¸ Soleggiato",
        1: "ğŸŒ¤ï¸ Sereno",
        2: "â›… Parzialmente nuvoloso",
        3: "â˜ï¸ Nuvoloso",
        45: "ğŸŒ«ï¸ Nebbioso",
        48: "ğŸŒ«ï¸ Nebbioso con brina",
        51: "ğŸŒ§ï¸ Pioggia leggera",
        53: "ğŸŒ§ï¸ Pioggia moderata",
        55: "ğŸŒ§ï¸ Pioggia intensa",
        61: "ğŸŒ§ï¸ Pioggia",
        63: "â›ˆï¸ Pioggia moderata",
        65: "â›ˆï¸ Pioggia intensa",
        80: "ğŸŒ§ï¸ Pioggia leggera",
        81: "ğŸŒ§ï¸ Pioggia moderata",
        82: "ğŸŒ§ï¸ Pioggia intensa",
        95: "â›ˆï¸ Temporale",
        96: "â›ˆï¸ Temporale con grandine",
        99: "â›ˆï¸ Temporale con grandine"
    }
    return weather_codes.get(code, "â“ Sconosciuto")

def display_weather(city_data, weather_data):
    """
    Visualizza i dati meteo in formato user-friendly
    """
    current = weather_data["current"]
    
    print("\n" + "="*50)
    print(f"ğŸŒ METEO - {city_data['name']}, {city_data['country']}")
    print("="*50)
    print(f"ğŸ“ Coordinate: {city_data['latitude']:.2f}Â°, {city_data['longitude']:.2f}Â°")
    print(f"ğŸ• Aggiornato: {current['time']}")
    print("-"*50)
    print(f"ğŸŒ¡ï¸  Temperatura: {current['temperature_2m']}Â°C")
    print(f"ğŸ’¨ Vento: {current['wind_speed_10m']} km/h")
    print(f"ğŸ’§ UmiditÃ : {current['relative_humidity_2m']}%")
    print(f"   Condizioni: {interpret_weather_code(current['weather_code'])}")
    print("="*50 + "\n")

def main():
    """
    Funzione principale
    """
    print("\nğŸŒ¤ï¸  === APPLICAZIONE METEO ===")
    
    city_name = input("Inserisci il nome di una cittÃ : ").strip()
    
    if not city_name:
        print("âŒ Nome cittÃ  non valido")
        return
    
    print(f"\nâ³ Recupero dati per '{city_name}'...")
    
    # Step 1: Recupera coordinate
    city_data = get_coordinates(city_name)
    if not city_data:
        return
    
    # Step 2: Recupera dati meteo
    weather_data = get_weather(city_data["latitude"], city_data["longitude"])
    if not weather_data:
        return
    
    # Step 3: Visualizza risultati
    display_weather(city_data, weather_data)

if __name__ == "__main__":
    main()